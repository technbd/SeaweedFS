## SeaweedFS Cluster:

A 03-node SeaweedFS cluster provides a simple, reliable, and cost-effective high-availability storage platform when configured correctly.


### Architecture Summary

- **Masters (3)** : Handle metadata routing and cluster state (lightweight, HA by design)
- **Volumes (3+)** : Store actual data, replicated across nodes
- **Filers (3)** : Provide filesystem semantics, S3, WebDAV, FUSE. For true HA, use PostgreSQL/MySQL instead of local LevelDB




### Environment:

| Service      |	Node IP        |
| ------------ | ----------------  |
| master01     |	192.168.10.190 |
| master02     |	192.168.10.192 | 
| master03     |	192.168.10.193 |
| filer01      |	192.168.10.191 |
| filer02      |	192.168.10.192 |
| filer03      |	192.168.10.193 |
| volumer01    |	192.168.10.191 |
| volumer02    |	192.168.10.192 |
| volumer03    |	192.168.10.193 |


### Create Directory (ALL NODES):

```
mkdir -p /opt/seaweedfs/{master,volume,filer,etc}
```

```
scp weed idea@192.168.10.191:/home/idea
scp weed idea@192.168.10.192:/home/idea
```


```
cp /home/idea/weed /usr/local/bin
```



### Master Server:

- The replication type is defined by a 3 digit string as follows:

| Digit | Meaning                                  |
| ----- | ---------------------------------------- |
| **X** | Replicas on **different racks**          |
| **Y** | Replicas on **different data centers**   |
| **Z** | Replicas on **different volume servers** |


- `defaultReplication=001` : `X=0, Y=0, Z=1` means 1 extra copy on a different volume server. 



_Prepare the master configuration file `/opt/seaweedfs/etc/master.conf`:_

```bash 
mdir=/opt/seaweedfs/master

# Current node IP:
ip=192.168.10.190
#ip=192.168.10.191
#ip=192.168.10.192
port=9333

# Three master addresses:
peers=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333

# Set cluster replication level to three replicas:
defaultReplication=001
```



#### node1:

```
weed master \
  -ip=192.168.10.190 \
  -port=9333 \
  -mdir=/opt/seaweedfs/master \
  -peers=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333 \
  -defaultReplication=001
```


Or,

```
weed master -options=/opt/seaweedfs/etc/master.conf
```


#### node2:

```
weed master \
  -ip=192.168.10.191 \
  -port=9333 \
  -mdir=/opt/seaweedfs/master \
  -peers=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333 \
  -defaultReplication=001
```


Or,

```
weed master -options=/opt/seaweedfs/etc/master.conf
```


#### node3:

```
weed master \
  -ip=192.168.10.192 \
  -port=9333 \
  -mdir=/opt/seaweedfs/master \
  -peers=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333 \
  -defaultReplication=001
```


Or,

```
weed master -options=/opt/seaweedfs/etc/master.conf
```



### Volume Server:


#### node1:

```
weed volume \
  -ip=192.168.10.190 \
  -port=8080 \
  -dir=/opt/seaweedfs/volume \
  -max=200 \
  -mserver=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333
```


#### node2:

```
weed volume \
  -ip=192.168.10.191 \
  -port=8080 \
  -dir=/opt/seaweedfs/volume \
  -max=200 \
  -mserver=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333
```


#### node3:

```
weed volume \
  -ip=192.168.10.192 \
  -port=8080 \
  -dir=/opt/seaweedfs/volume \
  -max=200 \
  -mserver=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333
```



### Filer Server:

#### node1:

```
weed filer \
  -ip=192.168.10.190 \
  -port=8888 \
  -defaultStoreDir=/opt/seaweedfs/filer \
  -master=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333
```


#### node2:

```
weed filer \
  -ip=192.168.10.191 \
  -port=8888 \
  -defaultStoreDir=/opt/seaweedfs/filer \
  -master=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333
```


#### node3:

```
weed filer \
  -ip=192.168.10.192 \
  -port=8888 \
  -defaultStoreDir=/opt/seaweedfs/filer \
  -master=192.168.10.190:9333,192.168.10.191:9333,192.168.10.192:9333
```





### Verify Cluster: 


_Check master leader:_
```
curl http://192.168.10.190:9333/cluster/status


{"IsLeader":true,"Leader":"192.168.10.190:9333","Peers":["192.168.10.191:9333","192.168.10.192:9333"]}
```



_Log in to any master node and enter the `weed shell` console:_
```
weed shell

## Common commands:
cluster.check # Check cluster network connectivity.
cluster.ps    # Check cluster process status.
volume.list   # List cluster volume servers.
```



_Upload via MASTER:_
```
echo "SeaweedFS HA OK" > test.txt

curl -F file=@test.txt http://192.168.10.190:9333/submit
```



_Upload via FILER:_
```
curl -F file=@test.txt http://192.168.10.190:8888/test.txt
```



_Get a file ID from MASTER:_
- `GET` request to `/dir/assign` to get a File ID (fid) and a volume server url

```
curl http://localhost:9333/dir/assign

{"fid":"5,034d3517ea","url":"192.168.10.191:8080","publicUrl":"192.168.10.191:8080","count":1}
```






### Access SeaweedFS:

```
Master UI: http://your-server-ip:9333

Volume UI: http://your-server-ip:8080

Filer UI: http://your-server-ip:8888
```




---
---




### S3 Gateway Server:

_Create Directory (ALL NODES):_
```
mkdir -p /opt/seaweedfs/s3
```


#### node1:

- Bucket metadata and IAM keys are stored in the Filer (`/opt/seaweedfs/filer`), not in `/opt/seaweedfs/s3`.
- S3 gateway mostly relies on Filer for metadata.


```
AWS_ACCESS_KEY_ID=minio AWS_SECRET_ACCESS_KEY=minio123 \
weed s3 \
-ip.bind=192.168.10.190 \
-port=8333 \
-filer=192.168.10.190:8888,192.168.10.191:8888,192.168.10.192:8888
```



#### node2:

```
AWS_ACCESS_KEY_ID=minio AWS_SECRET_ACCESS_KEY=minio123 \
weed s3 \
-ip.bind=192.168.10.191 \
-port=8333 \
-filer=192.168.10.190:8888,192.168.10.191:8888,192.168.10.192:8888
```


#### node3:

```
AWS_ACCESS_KEY_ID=minio AWS_SECRET_ACCESS_KEY=minio123 \
weed s3 \
-ip.bind=192.168.10.192 \
-port=8333 \
-filer=192.168.10.190:8888,192.168.10.191:8888,192.168.10.192:8888
```



#### Verify: 

```
./mc alias set s3seaweed http://192.168.10.190:8333 minio minio123
./mc alias list

./mc mb s3seaweed/mybucket
./mc cp /home/idea/test.txt s3seaweed/mybucket
./mc ls s3seaweed/mybucket
```


SeaweedFS S3 cluster behaves just like MinIO: multiple nodes, HA, S3 API compatible, easy to scale by adding gateways or volumes.




---
---


## LOAD BALANCER:

Expose ONE endpoint:
| Service | Port |
| ------- | ---- |
| Master  | 9333 |
| Filer   | 8888 |
| S3      | 8333 |



### MASTER Load Balancer (Port 9333): 

```
frontend seaweedfs_master
  bind *:9333
  mode http
  default_backend master_nodes

backend master_nodes
  mode http
  balance roundrobin
  option httpchk GET /cluster/status
  http-check expect status 200
  server m1 192.168.10.190:9333 check
  server m2 192.168.10.191:9333 check
  server m3 192.168.10.192:9333 check
```


### FILER Load Balancer (Port 8888):

```
frontend seaweedfs_filer
  bind *:8888
  mode http
  default_backend filer_nodes

backend filer_nodes
  mode http
  balance roundrobin
  option httpchk GET /
  http-check expect status 200
  server f1 192.168.10.190:8888 check
  server f2 192.168.10.191:8888 check
  server f3 192.168.10.192:8888 check
```


### S3 Load Balancer (Port 8333): (Optional) 

```
frontend seaweedfs_s3
  bind *:8333
  mode http
  default_backend s3_nodes

backend s3_nodes
  mode http
  balance roundrobin
  server s1 192.168.10.190:8333 check
  server s2 192.168.10.191:8333 check
  server s3 192.168.10.192:8333 check
```





SeaweedFS 3-node HA gives you enterprise-grade availability with startup-level simplicity.




